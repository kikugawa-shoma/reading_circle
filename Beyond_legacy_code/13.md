# 13. レガシーコードをリファクタリングする
- リファクタリングはソフトウェアの価値を高め、リスクを低くする
- リファクタリングにより削減されるコスト
  - あとからコードを理解するのにかかるコスト
  - ユニットテストの追加にかかるコスト
  - 新しい機能の追加にかかるコスト
  - さらなるリファクタリングにかかるコスト

## 13.1 投資か負債か？
- ソフトウェアには保守が必要不可欠
  - ソフトウェアが使われる世界は変化し続けるため
- 他の資産（不動産や車）と同様に「手入れ」が必要
- 手入れせずに使い続けると雪玉式に問題が大きくなる
---

- > 他の資産（不動産や車）と同様に「手入れ」が必要
  
  この比喩を使うとマネージャにリファクタリングの大切さを理解してもらいやすいかもしれない

- PoPでも言われていたこと


## 13.2 怠け者になる
- 「怠け者」：クレジットカードの支払い残を残さない人
- 技術的負債も金融的負債と同様
  - なるべく早くに返済することが大切

---

- 負債を負うのは許容していて、早く返さないことが問題だと言っている

## 13.3 コードの変更が必要なとき
- レガシーコードを変更する必要がある場合は、段階的にリファクタリングする
  段階的：
  1. テスト可能なようにモックを挿入できるようにしてテストを書く
  1. リファクタリングする
- 既存コードを変更しテスト可能なようにするのは、テストファースト開発よりも難しい場合もあるが、恩恵も大きい。
  恩恵：
  - 保守性の向上
  - 既存コードの変更コストの削減
- レガシーコードのリファクタリングはクリーンなコードを書くための最良の練習方法となり得る
- ソフトウェア開発者はソフトウェアが将来にわたって生み出し続ける価値の総和を最大化し、そのソフトウェアに払い続けるコストを最小化することが仕事

## 13.4 リファクタリングのテクニック
- ピンニングテスト
  - [ピンニングテスト](https://wiki.c2.com/?PinningTests)
  - 全体のふるまいをピンを打って固定するイメージ
  - エンドツーエンドの粒度の粗いテスト
- 依存性の注入
  - https://zenn.dev/chida/articles/e46a66cd9d89d1
  - https://qiita.com/okazuki/items/a0f2fb0a63ca88340ff6
- ストラングラーパターン
  - https://paulhammant.com/2013/07/14/legacy-application-strangulation-case-studies/
  - strangler:絞殺者
- 抽象化によるブランチ
  - 抽象化によりブランチを切ることなく実装を混在させることができる
  - https://bliki-ja.github.io/BranchByAbstraction/
  - 抽象化レイヤーを通じてテストできるようになる

## 13.5 変化み対応するためのリファクタリング
- レガシーコードを扱うための技術に共通する考え方：保守可能で理解しやすいように変え、安全に変更できるようにテストを組み込む。
## 13.6 オープン・クローズドにリファクタリングする
- オープン・クローズド：拡張に対して開いていて、変更に対して閉じている
  - 新しい機能の追加は、新しいコードの追加と最小限の既存コードの変更で済むようにする
- 2段階のプロセスで機能追加を行う
  - リファクタリングステップ
    - 新しい機能に対応できるように既存コードをリファクタリング
    - 抽象化したりインターフェースを定義したり
    - ユニットテストがなければ追加
    - このステップでは新しい機能の追加は行わない
  - 拡張ステップ
    - 新しい機能のためのユニットテストを書き、失敗させる(レッド)
    - 新しい機能を実装し、テストをパスさせる(グリーン)
    - 追加したコードのリファクタリングをする(リファクタ)
## 13.7 リファクタリングで変更しやすさを確保する
- プラクティスはあくまでプラクティス
- プラクティスによって良い設計やモデリングができるわけではない
- ただし今まで紹介してきたプラクティスは、ソフトウェア開発に生じる一般的な問題を解決するためのアプローチである

## 13.8 2回目は適切にやる
- 最初から正しくやるというのはプレッシャーになる
- いつでもリファクタリングできることを理解し、フィードバックループで改善していく

## 実践しよう
- リファクタリングから価値を得るための7つの戦略
  1. 既存のシステムを学ぶ
  1. 小さく改良する
  1. レガシーコードをテストで改良する
  1. クリーンアップをしながら進める
  1. 詳細が分かったら実装を再設計する
  1. 進む前にクリーンアップする
  1. やってはいけないことを学ぶリファクタリング
- いつリファクタリングを行うかの7つの戦略
  1. 重要なコードがうまく保守されないとき
  1. コードを理解している人が少ないとき
  1. 新しい情報によって、より良い設計が見つかったとき
  1. バグを修正するとき
  1. 新機能を追加するとき
  1. レガシーコードのドキュメントを書くとき
  1. 作り直すより安いとき




